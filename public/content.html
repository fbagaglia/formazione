<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtuale | AUD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --nero: #0C0D0D;
            --verde: #379557;
            --bianco-testo: #F2F5F3;
        }
        body { 
            background-color: var(--nero); 
            color: var(--bianco-testo); 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            scroll-behavior: smooth;
        }
        .hero-gradient { 
            background: radial-gradient(circle at top right, rgba(55, 149, 87, 0.1), var(--nero) 60%); 
            min-height: 100vh; 
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(12px);
            transition: all 0.3s ease; 
        }
        .glass-card:hover { 
            border-color: var(--verde); 
            background: rgba(255, 255, 255, 0.05); 
        }
        .topic-badge {
            background: rgba(55, 149, 87, 0.15);
            color: var(--verde);
            border: 1px solid rgba(55, 149, 87, 0.3);
        }
        /* Scrollbar personalizzata */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--nero); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--verde); }
    </style>
</head>
<body class="hero-gradient">
    <header class="border-b border-white/10 sticky top-0 bg-black/90 backdrop-blur-md z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="cursor-pointer flex items-center gap-4" onclick="window.history.back()">
                <div class="w-10 h-10 bg-[#379557] rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-emerald-900/20">AUD</div>
                <div>
                    <h1 class="text-white text-sm font-black uppercase tracking-widest leading-none">Aula Virtuale</h1>
                    <p id="nav-course-title" class="text-gray-500 text-[10px] mt-1 truncate max-w-[200px]">Caricamento in corso...</p>
                </div>
            </div>
            <button onclick="window.history.back()" class="text-[#379557] text-xs font-black uppercase tracking-widest hover:text-white transition-colors">
                ← Torna al Corso
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-12">
        <!-- Header del Corso -->
        <div id="course-header" class="mb-12 animate-in fade-in duration-1000">
            <div id="topics-container" class="flex flex-wrap gap-2 mb-8">
                <!-- Argomenti iniettati qui -->
            </div>
            <div class="w-12 h-1 bg-verde mb-6"></div>
            <h2 class="text-5xl md:text-6xl font-black text-white mb-4 tracking-tighter">Materiali e Attività.</h2>
            <p class="text-gray-400 text-lg max-w-2xl leading-relaxed">
                Tutto ciò che serve per nutrire la tua consapevolezza digitale, organizzato per argomenti e scadenze.
            </p>
        </div>

        <div class="grid lg:grid-cols-12 gap-12">
            
            <!-- Colonna Sinistra: Risorse e Bacheca (8/12) -->
            <div class="lg:col-span-8 space-y-16">
                
                <!-- Risorse Didattiche (Materials) -->
                <section>
                    <h3 class="text-xs font-black uppercase tracking-[0.3em] text-verde mb-8 flex items-center gap-3">
                        <span class="w-8 h-[1px] bg-verde"></span> Risorse e Materiali
                    </h3>
                    <div id="materials-list" class="space-y-6">
                        <div class="p-8 glass-card rounded-[32px] animate-pulse text-white/20">Sincronizzazione materiali...</div>
                    </div>
                </section>

                <!-- Bacheca (Announcements) -->
                <section>
                    <h3 class="text-xs font-black uppercase tracking-[0.3em] text-verde mb-8 flex items-center gap-3">
                        <span class="w-8 h-[1px] bg-verde"></span> Messaggi dalla Bacheca
                    </h3>
                    <div id="announcements-list" class="space-y-6">
                        <div class="p-8 glass-card rounded-[32px] animate-pulse text-white/20">Verifica nuovi messaggi...</div>
                    </div>
                </section>
            </div>

            <!-- Colonna Destra: Compiti (4/12) -->
            <aside class="lg:col-span-4 space-y-12">
                <section>
                    <h3 class="text-xs font-black uppercase tracking-[0.3em] text-verde mb-8 flex items-center gap-3">
                        <span class="w-8 h-[1px] bg-verde"></span> Lavori del Corso
                    </h3>
                    <div id="assignments-list" class="space-y-4">
                        <div class="p-6 glass-card rounded-2xl animate-pulse text-white/20">Recupero attività...</div>
                    </div>
                </section>

                <!-- Box Supporto -->
                <div class="p-8 bg-verde/5 border border-verde/20 rounded-[32px]">
                    <h4 class="text-white font-bold mb-3">Tutor AUD</h4>
                    <p class="text-gray-400 text-xs leading-relaxed mb-6">
                        Hai dubbi su un concetto o una consegna? La nostra missione è non lasciarti mai solo nel mare dei bit.
                    </p>
                    <a href="#" class="text-verde text-[10px] font-black uppercase tracking-widest hover:underline">Chiedi Supporto →</a>
                </div>
            </aside>
        </div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const courseId = params.get('id');

        async function fetchAllContent() {
            if (!courseId) {
                window.location.href = 'index.html';
                return;
            }

            try {
                // Esecuzione parallela delle chiamate per massimizzare la velocità
                const [courseRes, annRes, workRes, matRes, topRes] = await Promise.all([
                    fetch(`/api/classroom/courses/${courseId}`),
                    fetch(`/api/classroom/courses/${courseId}/announcements`),
                    fetch(`/api/classroom/courses/${courseId}/coursework`),
                    fetch(`/api/classroom/courses/${courseId}/materials`),
                    fetch(`/api/classroom/courses/${courseId}/topics`)
                ]);

                if (!courseRes.ok) throw new Error("Errore nel recupero dati");

                const course = await courseRes.json();
                const announcements = await annRes.json();
                const assignments = await workRes.json();
                const materials = await matRes.json();
                const topics = await topRes.json();
                
                document.getElementById('nav-course-title').innerText = course.title || "Aula Virtuale";
                
                renderTopics(topics);
                renderMaterials(materials);
                renderAnnouncements(announcements);
                renderAssignments(assignments);

            } catch (e) {
                console.error("Errore critico:", e);
                const errorHtml = `<div class='p-10 glass-card rounded-3xl text-red-500/80 font-bold text-center'>Impossibile sincronizzare i dati reali. Controlla i permessi o riprova più tardi.</div>`;
                document.getElementById('materials-list').innerHTML = errorHtml;
            }
        }

        function renderTopics(topics) {
            const container = document.getElementById('topics-container');
            if (!topics || topics.length === 0) return;
            container.innerHTML = topics.map(t => `
                <span class="px-4 py-1 rounded-full topic-badge text-[10px] font-black uppercase tracking-widest animate-in fade-in zoom-in duration-500">
                    ${t.name}
                </span>
            `).join('');
        }

        function renderMaterials(data) {
            const list = document.getElementById('materials-list');
            if (!data || data.length === 0) {
                list.innerHTML = `<div class='p-10 glass-card rounded-3xl text-gray-500 italic text-center text-sm'>Nessun materiale didattico caricato in questa sezione.</div>`;
                return;
            }
            list.innerHTML = data.map(m => `
                <div class="p-8 glass-card rounded-[32px] group animate-in slide-in-from-left-4 duration-500">
                    <h4 class="text-xl font-bold text-white mb-2 group-hover:text-verde transition-colors">${m.title}</h4>
                    <p class="text-gray-400 text-sm leading-relaxed mb-6">${m.description || 'Consulta questo materiale per approfondire l\'argomento del corso.'}</p>
                    <a href="${m.alternateLink}" target="_blank" class="inline-flex items-center gap-2 text-verde text-[10px] font-black uppercase tracking-widest hover:underline">
                        Visualizza su Classroom <span>→</span>
                    </a>
                </div>
            `).join('');
        }

        function renderAnnouncements(data) {
            const list = document.getElementById('announcements-list');
            if (!data || data.length === 0) {
                list.innerHTML = `<div class='p-10 glass-card rounded-3xl text-gray-500 italic text-center text-sm'>La bacheca è attualmente vuota.</div>`;
                return;
            }
            list.innerHTML = data.map(ann => `
                <div class="p-8 glass-card rounded-[32px] animate-in slide-in-from-left-4 duration-700">
                    <span class="text-[9px] text-gray-600 font-bold uppercase tracking-[0.2em] block mb-4">
                        Aggiornato il ${new Date(ann.updateTime).toLocaleDateString('it-IT')}
                    </span>
                    <div class="text-white/80 text-sm leading-relaxed whitespace-pre-wrap">${ann.text || 'Nessun testo presente'}</div>
                </div>
            `).join('');
        }

        function renderAssignments(data) {
            const list = document.getElementById('assignments-list');
            if (!data || data.length === 0) {
                list.innerHTML = `<div class='p-6 glass-card rounded-2xl text-gray-500 text-xs italic text-center'>Nessuna attività programmata.</div>`;
                return;
            }
            list.innerHTML = data.map(work => `
                <div class="p-6 glass-card rounded-2xl group transition-all animate-in slide-in-from-right-4 duration-500">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[9px] font-black bg-emerald-500/10 text-emerald-500 px-2 py-0.5 rounded uppercase">Attività</span>
                        <span class="text-[10px] text-gray-500 font-bold">${work.dueDate ? 'Scadenza' : 'Aperto'}</span>
                    </div>
                    <h4 class="font-bold text-white text-sm mb-4 leading-snug group-hover:text-verde transition-colors">${work.title}</h4>
                    <a href="${work.alternateLink}" target="_blank" class="block w-full py-3 bg-verde text-white hover:bg-[#2e7d49] text-center rounded-xl text-[10px] font-black uppercase tracking-[0.2em] transition-all shadow-lg shadow-emerald-900/10">
                        APRI COMPITO
                    </a>
                </div>
            `).join('');
        }

        window.onload = fetchAllContent;
    </script>
</body>
</html>
